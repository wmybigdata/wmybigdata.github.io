<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Introduce-the-upsert-kafka-Connector, java,jvm,hadoop,flink,hive,kafka,spark,hbase,clickhose,linux,superset等">
    <meta name="description" content="本网站是个人兴趣爱好，总结分享经验，记录生活点滴的平台，希望在以后的学习旅途中，走出自己的风景。">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Introduce-the-upsert-kafka-Connector | 情深骚明大数据之旅</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 4.2.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>



<script src="/js/FunnyTitle.js"></script>
<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">情深骚明大数据之旅</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">情深骚明大数据之旅</div>
        <div class="logo-desc">
            
            本网站是个人兴趣爱好，总结分享经验，记录生活点滴的平台，希望在以后的学习旅途中，走出自己的风景。
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/6.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Introduce-the-upsert-kafka-Connector</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Flink%E6%B5%81%E5%BC%8F%E5%BC%95%E6%93%8E/">
                                <span class="chip bg-color">Flink流式引擎</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Flink%E6%B5%81%E5%BC%8F%E5%BC%95%E6%93%8E/" class="post-category">
                                Flink流式引擎
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-08-24
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="Introduce-the-upsert-kafka-Connector"><a href="#Introduce-the-upsert-kafka-Connector" class="headerlink" title="Introduce-the-upsert-kafka-Connector"></a>Introduce-the-upsert-kafka-Connector</h1><p><a href="https://cwiki.apache.org/confluence/display/FLINK/FLIP-149%3A+Introduce+the+upsert-kafka+Connector" target="_blank" rel="noopener">参考文档</a></p>
<h2 id="一、动机"><a href="#一、动机" class="headerlink" title="一、动机"></a>一、动机</h2><p>通过邮件列表和社区问题，许多用户已经表达了他们对 upsert Kafka 的需求。在查看邮件列表后，我们认为背后有 3 个原因：</p>
<ul>
<li>将压缩的 kafka 主题解释为更改日志流，该流将带有键的记录解释为 upsert 事件 [1-3]； </li>
<li>作为实时管道的一部分，加入多个流以进行丰富并将结果存储到 Kafka 主题中以供以后进一步计算。但是，结果可能包含更新事件。</li>
<li>作为实时管道的一部分，聚合数据流并将结果存储到 Kafka 主题中以供以后进一步计算。但是，结果可能包含更新事件。</li>
</ul>
<h2 id="二、公共接口"><a href="#二、公共接口" class="headerlink" title="二、公共接口"></a>二、公共接口</h2><h3 id="1、Upsert-kafka-连接器定义"><a href="#1、Upsert-kafka-连接器定义" class="headerlink" title="1、Upsert-kafka 连接器定义"></a>1、Upsert-kafka 连接器定义</h3><p>Upsert-kafka 连接器产生一个变更日志流，其中每个数据记录代表一个更新或删除事件。更准确地说，数据记录中的值被解释为同一记录键的最后一个值的“更新”，如果有的话（如果相应的键不存在，则更新将被视为插入）。使用表类比，更改日志流中的数据记录被解释为 UPSERT 又名 INSERT/UPDATE，因为任何具有相同键的现有行都将被覆盖。此外，空值以特殊方式解释：具有空值的记录表示“删除”。</p>
<h3 id="2、upsert-kafka-上的主键约束"><a href="#2、upsert-kafka-上的主键约束" class="headerlink" title="2、upsert-kafka 上的主键约束"></a>2、upsert-kafka 上的主键约束</h3><p>当 upsert-kafka 连接器用作接收器时，它的工作方式类似于现有的 HBase 接收器。Upsert-kafka sink 不需要 planner 发送 UPDATE_BEFORE 消息（在某些情况下，planner 可能仍然会发送 UPDATE_BEFORE 消息），并且会将 INSERT/UPDATE_AFTER 消息写为带有关键部分的普通 Kafka 记录，并将 DELETE 消息写为带有 null 的 Kafka 记录值（指示键的墓碑）。Flink 将通过主键列的值对数据进行分区来保证主键上的消息排序。</p>
<p>Upsert-kafka 源是一种变更日志源。变更日志源上的主键语义意味着物化变更日志 (INSERT/UPDATE_BEFORE/UPDATE_AFTER/DELETE) 在主键约束上是唯一的。Flink 假设所有消息在主键上都是有序的。</p>
<p>在 Flink 中创建 upsert-kafka 表需要在表上声明主键。主键定义还控制哪些字段应该在 Kafka 的键中结束。因此，我们不需要 upsert-kafka 连接器中的 ‘key.fields’ 选项。默认情况下，主键字段也将存储在 Kafka 的值中。但是用户仍然可以使用选项“value.fields-include”来控制这种行为。</p>
<h3 id="3、Upsert-kafka-源"><a href="#3、Upsert-kafka-源" class="headerlink" title="3、Upsert-kafka 源"></a>3、Upsert-kafka 源</h3><p>一般来说，upsert-kafka源码的底层topic必须是<a href="https://kafka.apache.org/documentation/#compaction" target="_blank" rel="noopener">compacted</a>。另外，底层topic必须在同一个partition中包含所有key相同的数据，否则结果会出错。</p>
<p>目前，upsert-kafka 连接器不提供开始读取位置选项。必须从最早的偏移量读取 upsert-kafka 连接器。这是对数据完整性的保护，否则很难解释当用户指定从中间位置开始偏移时的行为以及如何处理从未见过密钥的删除事件。因此，更新插入-kafka连接器不提供类似的选项<code>'``scan.startup.mode'</code>， “和” （仅用于“ ”启动模式）。<code>scan.startup.specific-offsets'``'scan.startup.timestamp-millis'``properties.group.id'``group-offsets</code></p>
<h3 id="4、Upsert-kafka-接收器"><a href="#4、Upsert-kafka-接收器" class="headerlink" title="4、Upsert-kafka 接收器"></a>4、Upsert-kafka 接收器</h3><p>为了保证消息排序，upsert-kafka sink 将始终在主键字段上以 HASH 分区器模式工作。因此，我们不需要<code>sink.partitioner</code>upsert-kafka 连接器中的 ‘ ‘ 选项。 </p>
<p>5、Upsert-kafka 连接器选项</p>
<p>upsert-kafka Connector 中的选项很像 Kafka Connector。</p>
<table>
<thead>
<tr>
<th>connector</th>
<th>required</th>
<th>(none)</th>
<th>String</th>
<th>Specify what connector to use, here should be ‘upsert-kafka’.</th>
</tr>
</thead>
<tbody><tr>
<td>properties.bootstrap.servers</td>
<td>required</td>
<td>(none)</td>
<td>String</td>
<td>Comma separated list of Kafka brokers.</td>
</tr>
<tr>
<td>key.format</td>
<td>required</td>
<td>(none)</td>
<td>String</td>
<td>The format used to deserialize and serialize the key of Kafka record. Only insert-only format is supported.</td>
</tr>
<tr>
<td>value.format</td>
<td>required</td>
<td>(none)</td>
<td>String</td>
<td>The format used to deserialize and serialize the value of Kafka records.</td>
</tr>
<tr>
<td>topic</td>
<td>optional</td>
<td>(none)</td>
<td>String</td>
<td>Topic name(s) to read data from when the table is used as source or to write data to when the table is used as sink. Note, only one of “<code>topic-pattern</code>“ and “<code>topic</code>“ can be specified for sources. When the table is used as sink, the topic name is the topic to write data to. Note topic list is not supported for sinks.</td>
</tr>
<tr>
<td>topic-pattern</td>
<td>optional</td>
<td>(none)</td>
<td>String</td>
<td>The regular expression for a pattern of topic names to read from. All topics with names that match the specified regular expression will be subscribed by the consumer when the job starts running. Note, only one of “<code>topic-pattern</code>“ and “<code>topic</code>“ can be specified for sources.</td>
</tr>
<tr>
<td>value.fields-include</td>
<td>optional</td>
<td>‘ALL’</td>
<td>String</td>
<td>Controls which fields should end up in the value as well, possible values -  ALL (all fields of the schema, even if they are part of e.g. the key)-  EXCEPT_KEY (all fields of the schema - fields of the key)</td>
</tr>
</tbody></table>
<p><strong>注意：</strong>仅支持将仅插入格式用作<code>'key.format'</code>和 ‘ <code>value.format</code>‘。我们将使用<code>ChangelogMode</code>格式的 来区分格式是否为仅插入。</p>
<h2 id="三、背景介绍"><a href="#三、背景介绍" class="headerlink" title="三、背景介绍"></a>三、背景介绍</h2><p>在某些场景中，比如GROUP BY聚合之后的结果，需要去更新之前的结果值。这个时候，需要将 Kafka 消息记录的 key 当成主键处理，用来确定一条数据是应该作为插入、删除还是更新记录来处理。在Flink1.11中，可以通过 <strong>flink-cdc-connectors</strong> 项目提供的 <strong>changelog-json format</strong>来实现该功能。关于该功能的使用，见之前的分享<a href="https://mp.weixin.qq.com/s?__biz=MzU2ODQ3NjYyMA==&amp;mid=2247484891&amp;idx=2&amp;sn=5fcf4ec7c4519cf69528d66caccbdd95&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">Flink1.11中的CDC Connectors操作实践</a>。</p>
<p>在Flink1.12版本中， 新增了一个 **upsert connector(upsert-kafka)**，该 connector 扩展自现有的 Kafka connector，工作在 upsert 模式（FLIP-149）下。新的 upsert-kafka connector 既可以作为 source 使用，也可以作为 sink 使用，并且提供了与现有的 kafka connector 相同的基本功能和持久性保证，因为两者之间复用了大部分代码。本文将以Flink1.13.2为例，介绍该功能的基本使用步骤，以下是全文，希望对你有所帮助。</p>
<h3 id="1-Upsert-Kafka-connector简介"><a href="#1-Upsert-Kafka-connector简介" class="headerlink" title="1 Upsert Kafka connector简介"></a>1 Upsert Kafka connector简介</h3><p><strong>Upsert Kafka Connector</strong>允许用户以upsert的方式从Kafka主题读取数据或将数据写入Kafka主题。</p>
<p><strong>当作为数据源时</strong>，upsert-kafka Connector会生产一个changelog流，其中每条数据记录都表示一个更新或删除事件。更准确地说，如果不存在对应的key，则视为<strong>INSERT</strong>操作。如果已经存在了相对应的key，则该key对应的value值为最后一次更新的值。</p>
<p>用表来类比，changelog 流中的数据记录被解释为 UPSERT，也称为 INSERT/UPDATE，因为任何具有相同 key 的现有行都被覆盖。另外，value 为空的消息将会被视作为 DELETE 消息。</p>
<p><strong>当作为数据汇时</strong>，upsert-kafka Connector会消费一个changelog流。它将<strong>INSERT / UPDATE_AFTER</strong>数据作为正常的Kafka消息值写入(即INSERT和UPDATE操作，都会进行正常写入，如果是更新，则同一个key会存储多条数据，但在读取该表数据时，只保留最后一次更新的值)，并将 DELETE 数据以 value 为空的 Kafka 消息写入（key被打上墓碑标记，表示对应 key 的消息被删除）。Flink 将根据主键列的值对数据进行分区，从而保证主键上的消息有序，因此同一主键上的更新/删除消息将落在同一分区中</p>
<h3 id="2-依赖"><a href="#2-依赖" class="headerlink" title="2 依赖"></a>2 依赖</h3><p>为了使用Upsert Kafka连接器，需要添加下面的依赖</p>
<pre class=" language-xml"><code class="language-xml"><span class="token comment" spellcheck="true">&lt;!-- https://mvnrepository.com/artifact/org.apache.flink/flink-connector-kafka --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>flink-connector-kafka_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.13.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
</code></pre>
<h3 id="3-使用方式"><a href="#3-使用方式" class="headerlink" title="3 使用方式"></a>3 使用方式</h3><p><strong>使用样例</strong></p>
<pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">-- 创建一张kafka表，用户存储sink的数据</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> pageviews_per_region <span class="token punctuation">(</span>
  user_region STRING<span class="token punctuation">,</span>
  pv <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
  uv <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>user_region<span class="token punctuation">)</span> <span class="token operator">NOT</span> ENFORCED
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
  <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'upsert-kafka'</span><span class="token punctuation">,</span>
  <span class="token string">'topic'</span> <span class="token operator">=</span> <span class="token string">'pageviews_per_region'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.bootstrap.servers'</span> <span class="token operator">=</span> <span class="token string">'flink04:9092,flink05:9092,flink06:9092'</span><span class="token punctuation">,</span>
  <span class="token string">'key.format'</span> <span class="token operator">=</span> <span class="token string">'avro'</span><span class="token punctuation">,</span>
  <span class="token string">'value.format'</span> <span class="token operator">=</span> <span class="token string">'avro'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>创建表之后出现问题</p>
<p><img src="https://gitee.com/wmybigdata/blog-drawing-bed/raw/master/img/image-20210824161258282.png" alt="出现问题"></p>
<p>尖叫提示：</p>
<p>要使用 upsert-kafka connector，必须在创建表时使用<strong>PRIMARY KEY</strong>定义主键，并为键（key.format）和值（value.format）指定序列化反序列化格式。</p>
<p><strong>upsert-kafka connector参数</strong></p>
<ul>
<li><strong>connector</strong></li>
</ul>
<p><strong>必选</strong>。指定要使用的连接器，Upsert Kafka 连接器使用：<code>'upsert-kafka'</code>。</p>
<ul>
<li><strong>topic</strong></li>
</ul>
<p><strong>必选</strong>。用于读取和写入的 Kafka topic 名称。</p>
<ul>
<li><strong>properties.bootstrap.servers</strong></li>
</ul>
<p><strong>必选</strong>。以逗号分隔的 Kafka brokers 列表。</p>
<ul>
<li><strong>key.format</strong></li>
</ul>
<p><strong>必选</strong>。用于对 Kafka 消息中 key 部分序列化和反序列化的格式。key 字段由<strong>PRIMARY KEY</strong> 语法指定。支持的格式包括 <code>'csv'</code>、<code>'json'</code>、<code>'avro'</code>。</p>
<ul>
<li><strong>value.format</strong></li>
</ul>
<p><strong>必选</strong>。用于对 Kafka 消息中 value 部分序列化和反序列化的格式。支持的格式包括 <code>'csv'</code>、<code>'json'</code>、<code>'avro'</code>。</p>
<ul>
<li><strong>properties.</strong>*</li>
</ul>
<p><strong>可选</strong>。该选项可以传递任意的 Kafka 参数。选项的后缀名必须匹配定义在 Kafka 参数文档中的参数名。Flink 会自动移除 选项名中的 “properties.” 前缀，并将转换后的键名以及值传入 KafkaClient。例如，你可以通过 </p>
<p><code>'properties.allow.auto.create.topics' = 'false'</code> 来禁止自动创建 topic。但是，某些选项，例如<code>'key.deserializer'</code> 和 <code>'value.deserializer'</code> 是不允许通过该方式传递参数，因为 Flink 会重写这些参数的值。</p>
<ul>
<li><strong>value.fields-include</strong></li>
</ul>
<p><strong>可选</strong>，默认为<strong>ALL</strong>。控制key字段是否出现在 value 中。当取<strong>ALL</strong>时，表示<code>消息的 value 部分将包含 schema 中所有的字段，包括定义为主键的字段。</code>当取<strong>EXCEPT_KEY</strong>时，表示记录的 value 部分包含 schema 的所有字段，定义为主键的字段除外。</p>
<ul>
<li><strong>key.fields-prefix</strong></li>
</ul>
<p><strong>可选</strong>。为了避免与value字段命名冲突，为key字段添加一个自定义前缀。默认前缀为空。一旦指定了key字段的前缀，必须在DDL中指明前缀的名称，但是在构建key的序列化数据类型时，将移除该前缀。见下面的示例。在需要注意的是：使用该配置属性，<strong>value.fields-include</strong>的值必须为<strong>EXCEPT_KEY</strong>。</p>
<p>尖叫提示：</p>
<p>如果指定了key字段前缀，但在DDL中并没有添加该前缀字符串，那么在向该表写入数时，会抛出下面异常：</p>
<p>[ERROR] Could not execute SQL statement. Reason: org.apache.flink.table.api.ValidationException: All fields in ‘key.fields’ must be prefixed with ‘qwe’ when option ‘key.fields-prefix’ is set but field ‘do_date’ is not prefixed.</p>
<pre class=" language-sql"><code class="language-sql"> <span class="token comment" spellcheck="true">-- 创建一张upsert表，当指定了qwe前缀，涉及的key必须指定qwe前缀</span>
 <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> result_total_pvuv_min_prefix <span class="token punctuation">(</span>
     qwedo_date     STRING<span class="token punctuation">,</span>     <span class="token comment" spellcheck="true">-- 统计日期，必须包含qwe前缀</span>
     qwedo_min      STRING<span class="token punctuation">,</span>      <span class="token comment" spellcheck="true">-- 统计分钟，必须包含qwe前缀</span>
     pv          <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>     <span class="token comment" spellcheck="true">-- 点击量</span>
     uv          <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>     <span class="token comment" spellcheck="true">-- 一天内同个访客多次访问仅计算一个UV</span>
     currenttime <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">-- 当前时间</span>
     <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>qwedo_date<span class="token punctuation">,</span> qwedo_min<span class="token punctuation">)</span> <span class="token operator">NOT</span> ENFORCED <span class="token comment" spellcheck="true">-- 必须包含qwe前缀</span>
 <span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
   <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'upsert-kafka'</span><span class="token punctuation">,</span>
   <span class="token string">'topic'</span> <span class="token operator">=</span> <span class="token string">'result_total_pvuv_min_prefix'</span><span class="token punctuation">,</span>
   <span class="token string">'properties.bootstrap.servers'</span> <span class="token operator">=</span> <span class="token string">'kms-2:9092,kms-3:9092,kms-4:9092'</span><span class="token punctuation">,</span>
   <span class="token string">'key.json.ignore-parse-errors'</span> <span class="token operator">=</span> <span class="token string">'true'</span><span class="token punctuation">,</span>
   <span class="token string">'value.json.fail-on-missing-field'</span> <span class="token operator">=</span> <span class="token string">'false'</span><span class="token punctuation">,</span>
   <span class="token string">'key.format'</span> <span class="token operator">=</span> <span class="token string">'json'</span><span class="token punctuation">,</span>
   <span class="token string">'value.format'</span> <span class="token operator">=</span> <span class="token string">'json'</span><span class="token punctuation">,</span>
   <span class="token string">'key.fields-prefix'</span><span class="token operator">=</span><span class="token string">'qwe'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">-- 指定前缀qwe</span>
   <span class="token string">'value.fields-include'</span> <span class="token operator">=</span> <span class="token string">'EXCEPT_KEY'</span> <span class="token comment" spellcheck="true">-- key不出现kafka消息的value中</span>
 <span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment" spellcheck="true">-- 向该表中写入数据</span>
 <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> result_total_pvuv_min_prefix
 <span class="token keyword">SELECT</span>
   do_date<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">--  时间分区</span>
   cast<span class="token punctuation">(</span>DATE_FORMAT <span class="token punctuation">(</span>access_time<span class="token punctuation">,</span><span class="token string">'HH:mm'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> STRING<span class="token punctuation">)</span> <span class="token keyword">AS</span> do_min<span class="token punctuation">,</span><span class="token comment" spellcheck="true">-- 分钟级别的时间</span>
   pv<span class="token punctuation">,</span>
   uv<span class="token punctuation">,</span>
   <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">AS</span> currenttime <span class="token comment" spellcheck="true">-- 当前时间</span>
 <span class="token keyword">from</span>
   view_total_pvuv_min<span class="token punctuation">;</span>
</code></pre>
<ul>
<li><strong>sink.parallelism</strong></li>
</ul>
<p><strong>可选</strong>。定义 upsert-kafka sink 算子的并行度。默认情况下，由框架确定并行度，与上游链接算子的并行度保持一致。</p>
<h3 id="4-其他注意事项"><a href="#4-其他注意事项" class="headerlink" title="4 其他注意事项"></a>4 其他注意事项</h3><p><strong>Key和Value的序列化格式</strong></p>
<p>关于Key、value的序列化可以参考Kafka connector。值得注意的是，必须指定Key和Value的序列化格式，其中Key是通过<strong>PRIMARY KEY</strong>指定的。</p>
<p><strong>Primary Key约束</strong></p>
<p><strong>Upsert Kafka</strong> 工作在 upsert 模式（FLIP-149）下。当我们创建表时，需要在 DDL 中定义主键。具有相同key的数据，会存在相同的分区中。在 changlog source 上定义主键意味着在物化后的 changelog 上主键具有唯一性。定义的主键将决定哪些字段出现在 Kafka 消息的 key 中。</p>
<p><strong>一致性保障</strong></p>
<p>默认情况下，如果启用 checkpoint，Upsert Kafka sink 会保证至少一次将数据插入 Kafka topic。</p>
<p>这意味着，Flink 可以将具有相同 key 的重复记录写入 Kafka topic。但由于该连接器以 upsert 的模式工作，该连接器作为 source 读入时，可以确保具有相同主键值下仅最后一条消息会生效。因此，upsert-kafka 连接器可以像 HBase sink 一样实现幂等写入。</p>
<p><strong>分区水位线</strong></p>
<p>Flink 支持根据 Upsert Kafka 的 每个分区的数据特性发送相应的 watermark。当使用这个特性的时候，watermark 是在 Kafka consumer 内部生成的。合并每个分区生成的 watermark 的方式和 streaming shuffle 的方式是一致的(<strong>单个分区的输入取最大值，多个分区的输入取最小值</strong>)。数据源产生的 watermark 是取决于该 consumer 负责的所有分区中当前最小的 watermark。如果该 consumer 负责的部分分区是空闲的，那么整体的 watermark 并不会前进。在这种情况下，可以通过设置合适的 table.exec.source.idle-timeout 来缓解这个问题。</p>
<p><strong>数据类型</strong></p>
<p>Upsert Kafka 用字节bytes存储消息的 key 和 value，因此没有 schema 或数据类型。消息按格式进行序列化和反序列化，例如：csv、json、avro。不同的序列化格式所提供的数据类型有所不同，因此需要根据使用的序列化格式进行确定表字段的数据类型是否与该序列化类型提供的数据类型兼容。</p>
<h2 id="四、实施细则"><a href="#四、实施细则" class="headerlink" title="四、实施细则"></a>四、实施细则</h2><p>由于 upsert-kafka 连接器只产生不包含 UPDATE_BEFORE 消息的 upsert 流。但是，一些操作需要 UPDATE_BEFORE 消息才能正确处理，例如聚合。因此，我们需要一个物理节点来实现 upsert 流并生成带有完整更改消息的更改日志流。在物理运算符中，我们将使用状态来知道密钥是否是第一次被看到。该运算符将生成 INSERT 行，或额外为前一个图像生成 UPDATE_BEFORE 行，或生成所有列都填充有值的 DELETE 行。</p>
<p>规划者怎么知道要添加这样的物化算子呢？这取决于 FLIP-95 中引入的源的 ChangeMode。目前，我们仅支持仅插入或所有类型（例如 CDC 格式）的 ChangelogMode。在此 FLIP 中，我们将支持 [UPDATE_AFTER, DELETE] ChangelogMode，这表明源将在运行时仅发出 UPDATE_AFTER 和 DELETE 消息。当source的ChangelogMode为[UPDATE_AFTER, DELETE]时，planner会添加上面的物化算子。 </p>
<p>考虑到 Kafka 连接器和 upsert-kafka 连接器之间的相似性，我们应该重用引擎盖下的大部分代码，只引入不同的连接器工厂。</p>
<h2 id="五、兼容性、弃用和迁移计划"><a href="#五、兼容性、弃用和迁移计划" class="headerlink" title="五、兼容性、弃用和迁移计划"></a>五、兼容性、弃用和迁移计划</h2><p>此更改引入了一项新功能，但并不意味着任何兼容性问题。</p>
<h2 id="六、被拒绝的替代品"><a href="#六、被拒绝的替代品" class="headerlink" title="六、被拒绝的替代品"></a>六、被拒绝的替代品</h2><h3 id="1、在-Kafka-连接器中引入新属性-vs-引入-upsert-kafka-连接器"><a href="#1、在-Kafka-连接器中引入新属性-vs-引入-upsert-kafka-连接器" class="headerlink" title="1、在 Kafka 连接器中引入新属性 vs 引入 upsert-kafka 连接器"></a>1、在 Kafka 连接器中引入新属性 vs 引入 upsert-kafka 连接器</h3><ol>
<li>很难解释当用户指定从中间位置开始偏移时的行为（例如如何处理不存在的删除事件）。如果用户这样做是很危险的。所以我们目前没有在新的连接器中提供偏移选项。</li>
<li>这是对同一个 kafka 主题的不同视角/抽象（附加与更新插入）。如果我们可以将它们分开而不是将它们混合在一个连接器中会更容易理解。新连接器需要散列接收器分区器、主键声明、常规格式。如果我们将它们混合在一个连接器中，则可能会混淆如何正确使用这些选项。</li>
<li>upsert-kafka 连接器的语义与 Kafka Stream 中的 KTable 相同。所以对于Kafka Stream和KSQL用户来说非常方便。我们在邮件列表中看到了几个问题 [1][2]，询问如何对 KTable 进行建模以及如何在 Flink SQL 中加入 KTable。</li>
</ol>
<h3 id="2、使用-upsert-kafka-作为新的连接器名称-vs-使用-kafka-compacted-作为名称-vs-使用-ktable-作为名称"><a href="#2、使用-upsert-kafka-作为新的连接器名称-vs-使用-kafka-compacted-作为名称-vs-使用-ktable-作为名称" class="headerlink" title="2、使用 upsert-kafka 作为新的连接器名称 vs 使用 kafka- compacted 作为名称 vs 使用 ktable 作为名称"></a>2、使用 upsert-kafka 作为新的连接器名称 vs 使用 kafka- compacted 作为名称 vs 使用 ktable 作为名称</h3><p>考虑到 KTable 的隐含含义比预期的要多，并且 kafka-compacted 中的压缩含义与 topic 而不是 table 本身相关，因此更适合使用 upsert-kafka 作为新连接器的名称，这更直接。</p>
<h2 id="七、未来工作"><a href="#七、未来工作" class="headerlink" title="七、未来工作"></a>七、未来工作</h2><h3 id="1、支持有界-upsert-kafka-源"><a href="#1、支持有界-upsert-kafka-源" class="headerlink" title="1、支持有界 upsert-kafka 源"></a>1、支持有界 upsert-kafka 源</h3><p>用户也可能希望以批处理模式使用 upsert-kafka 连接器。但是我们需要更多地讨论这个特性。</p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">情深骚明</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://github.com/wmybigdata/2021/08/24/Introduce-the-upsert-kafka-Connector/">https://github.com/wmybigdata/2021/08/24/Introduce-the-upsert-kafka-Connector/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">情深骚明</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Flink%E6%B5%81%E5%BC%8F%E5%BC%95%E6%93%8E/">
                                    <span class="chip bg-color">Flink流式引擎</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2021/08/24/FlinkCDC%E5%9C%A8sqlClient%E7%9A%84%E4%BD%BF%E7%94%A8/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/14.jpg" class="responsive-img" alt="FlinkCDC在sqlClient的使用">
                        
                        <span class="card-title">FlinkCDC在sqlClient的使用</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            学习心得记录
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-08-24
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Flink%E6%B5%81%E5%BC%8F%E5%BC%95%E6%93%8E/" class="post-category">
                                    Flink流式引擎
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Flink%E6%B5%81%E5%BC%8F%E5%BC%95%E6%93%8E/">
                        <span class="chip bg-color">Flink流式引擎</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/08/24/Flink1-12-0%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/23.jpg" class="responsive-img" alt="Flink1.12.0源码阅读">
                        
                        <span class="card-title">Flink1.12.0源码阅读</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            学习心得记录
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-08-24
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Flink%E6%B5%81%E5%BC%8F%E5%BC%95%E6%93%8E/" class="post-category">
                                    Flink流式引擎
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Flink%E6%B5%81%E5%BC%8F%E5%BC%95%E6%93%8E/">
                        <span class="chip bg-color">Flink流式引擎</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2021</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">情深骚明</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/wmybigdata/" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:wmy_2000@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2647716549" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2647716549" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>


    <a href="https://github.com/wmybigdata/" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="https://github.com/wmybigdata/" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:wmy_2000@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2647716549" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2647716549" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>







    <a href="https://blog.csdn.net/weixin_45098163" class="tooltipped" target="_blank" data-tooltip="关注我的CSDN: https://blog.csdn.net/weixin_45098163" data-position="top" data-delay="50">
        <i class="fab fa-csdn">C</i>
    </a>




</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
